#!/bin/bash -e
log-helper level eq trace && set -x

# This tool helps to generate tls certificates with cfssl
# or get certificates from a json file

PREFIX=$1
CERT_FILE=$2
KEY_FILE=$3
CA_FILE=$4

log-helper debug "Hi! I'm ssl-helper, what button should i press ?"

# set env vars
PREFIX=${PREFIX^^} # uppercase

PREFIX_SSL_HELPER_TOOL=${PREFIX}_SSL_HELPER_TOOL
PREFIX_SSL_HELPER_AUTO_RENEW=${PREFIX}_SSL_HELPER_AUTO_RENEW
PREFIX_SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED=${PREFIX}_SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED
PREFIX_SSL_HELPER_AUTO_RENEW_FROM_FILES=${PREFIX}_SSL_HELPER_AUTO_RENEW_FROM_FILES
PREFIX_SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE
PREFIX_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE
PREFIX_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE

SSL_HELPER_TOOL=${!PREFIX_SSL_HELPER_TOOL:-$SSL_HELPER_TOOL}
SSL_HELPER_AUTO_RENEW=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW}
SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED=${!PREFIX_SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED:-$SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED}
SSL_HELPER_AUTO_RENEW_FROM_FILES=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW_FROM_FILES}
SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE}
SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE}
SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE}

source ${CONTAINER_SERVICE_DIR}/:ssl-tools/assets/default-env

# call the certificate tool cfssl-helper (default) or jsonssl-helper
$SSL_HELPER_TOOL $PREFIX $CERT_FILE $KEY_FILE $CA_FILE

# auto-renew certificates just before it expired
if [ "${SSL_HELPER_AUTO_RENEW,,}" = "true" ]; then

  # only for multiple process images (uses cron)
  if [ ! -e "/container/multiple_process_stack_added" ]; then
    log-helper error "auto-renew is available only with multiple process images"
    exit 1
  fi

  # check if SSL_HELPER_AUTO_RENEW_FROM_FILE=true certificate source files
  if [ "${SSL_HELPER_AUTO_RENEW_FROM_FILE,,}" = "true" ]; then
    if [ ! -e "$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE" ] || [ ! -e "$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE" ] || [ ! -e "$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE" ]; then
      log-helper error "with SSL_HELPER_AUTO_RENEW_FROM_FILE=true the following files must exists:"
      log-helper error "SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE"
      log-helper error "SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE"
      log-helper error "SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE"
      exit 1
    fi
  fi

  # add cron job every day at 00:00
  echo "0 0 * * * root /usr/sbin/ssl-auto-renew $SSL_HELPER_TOOL $PREFIX $CERT_FILE $KEY_FILE $CA_FILE \"$SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED\" \"$SSL_HELPER_AUTO_RENEW_FROM_FILES\" \"$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE\" \"$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE\" \"$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE\" 2>&1 | /usr/bin/logger -s -t ssl-auto-renew" > /etc/cron.d/$PREFIX
  chmod 600 /etc/cron.d/$PREFIX

# disable auto-renew if it was added
elif [ -e "/etc/cron.d/$PREFIX" ]; then
  rm -f /etc/cron.d/$PREFIX
fi

exit 0
