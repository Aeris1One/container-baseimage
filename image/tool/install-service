#!/bin/bash -e

echo "install-service"

# Auto run global install script if available
if [ -f "/container/service/install.sh" ]; then
  echo "run /container/service/install.sh"
  ./container/service/install.sh
  echo "remove /container/service/install.sh"
  rm -f /container/service/install.sh
fi

# Process install script of services in /container/service
for i in $(find /container/service -mindepth 2 -maxdepth 2 -type f -name "install.sh" | sort); do
  echo "run $i"
  $i
  echo "remove $i"
  rm -f $i
done

echo "Searching process..."
nbProcess=$(find /container/service -mindepth 2 -maxdepth 2 -type f -name "process.sh" | wc -l )
echo "$nbProcess process found"

# Multiple process image
if [ "$nbProcess" -gt 1 ] && [ ! -e "/container/multiple_process_stack_added" ]; then
  echo "This image has multiple process."
  /container/tool/add-multiple-process-stack
  echo "For better image build process consider adding :"
  echo "\"/container/tool/add-multiple-process-stack\" after an apt-get update in your Dockerfile."
fi
